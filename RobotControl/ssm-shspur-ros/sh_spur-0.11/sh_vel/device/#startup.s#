!*****************************************************************************
!   SH7045’¥Þ’¥¤’¥³’¥ó’¥Ü’¡¼’¥É’¡¡’¥¹’¥¿’¡¼’¥È’¥¢’¥Ã’¥×’¥ë’¡¼’¥Á’¥ó
!                                          (C) 30Nov2003 T.KOSAKA, A.YAMASHITA
!  
!  ’¤³’¤Î’¥¹’¥¿’¡¼’¥È’¥¢’¥Ã’¥×’¤Ç’¹Ô’¤Ê’¤Ã’¤Æ’¤¤’¤ë’¤³’¤È
!  ’¡Ê’£±’¡Ë’¥¹’¥¿’¥Ã’¥¯’¥Ý’¥¤’¥ó’¥¿’¤Î’½é’´ü’²½
!  ’¡Ê’£²’¡Ë’¥Þ’¥ë’¥Á’¥×’¥ì’¥Ã’¥¯’¥¹’¥Ô’¥ó’¤Î’½é’´ü’²½
!      ’¡Ê’¥¢’¥É’¥ì’¥¹’¤È’¥Ý’¡¼’¥È’¶¦’ÍÑ’¤Î’¥Ô’¥ó’¤ò’¥¢’¥É’¥ì’¥¹’¤È’¤·’¤Æ’»È’¤¨’¤ë’¤è’¤¦’¤Ë’¤¹’¤ë’¤Ê’¤É’¡Ë
!  ’¡Ê’£³’¡Ë’ÊÑ’¿ô’ÎÎ’°è’¤Ø’¤Î’½é’´ü’ÃÍ’¤Î’¥³’¥Ô’¡¼
!  ’¡Ê’£´’¡Ë’½é’´ü’ÃÍ’¤ò’»ý’¤¿’¤Ê’¤¤’ÊÑ’¿ô’ÎÎ’°è’¤Î’¥¯’¥ê’¥¢’¡Ê’¤³’¤ì’¤Ï’¥µ’¡¼’¥Ó’¥¹’¡Ë
!  ’¡Ê’£µ’¡Ëmain()’¤Î’¸Æ’¤Ó’½Ð’¤·’¤È’Ä¾’¸å’¤Ë’Ìµ’¸Â’¥ë’¡¼’¥×’¤Î’Àß’ÃÖ
!  ’¤³’¤Î’¥¹’¥¿’¡¼’¥È’¥¢’¥Ã’¥×’¥ë’¡¼’¥Á’¥ó’¥Õ’¥¡’¥¤’¥ë’¤Ç’¤Î’¥µ’¡¼’¥Ó’¥¹’´Ø’¿ô
!  ’¡Ê’£±’¡Ëvoid setIntMask(int mask)’¡¡’³ä’¤ê’¹þ’¤ß’¥Þ’¥¹’¥¯’¤Î’Àß’Äê’´Ø’¿ô
!  ’¡Ê’£²’¡Ëint getIntMask(void)’¡¡’³ä’¤ê’¹þ’¤ß’¥Þ’¥¹’¥¯’¤Î’ÆÉ’¤ß’½Ð’¤·’´Ø’¿ô
!  ’¡Ê’£³’¡Ë__main()’¡¡’¥À’¥ß’¡¼’´Ø’¿ô
!      ’¤³’¤ì’¤ò’Äê’µÁ’¤·’¤Æ’¤ª’¤¯’¤È’Í½’´ü’¤·’¤Ê’¤¤’¥é’¥¤’¥Ö’¥é’¥ê’´Ø’¿ô’¤¬’ÉÕ’²Ã’¤µ’¤ì’¤ë’¤³’¤È’¤¬’¤Ê’¤¤
!*****************************************************************************
    .section    .text          ! ’¥¹’¥¿’¡¼’¥È’¥¢’¥Ã’¥×’¥ë’¡¼’¥Á’¥ó’¤òROM’ÎÎ’°è’¤Ë’½ñ’¤­’¹þ’¤ß
    .global     _start         ! ’¥×’¥í’¥°’¥é’¥à’³«’»Ï’°Ì’ÃÖ’¤ò’¥¨’¥¯’¥¹’¥Ý’¡¼’¥È
    .extern     _dataRAM_begin
    .extern     _dataRAM_end
    .extern     _dataROM_begin
    .extern     _bss_begin
    .extern     _bss_end

_start:                                 ! ’¥×’¥í’¥°’¥é’¥à’³«’»Ï’°Ì’ÃÖ
!-----------------------------------------------------------------------------
! ’¥¹’¥¿’¥Ã’¥¯’¥Ý’¥¤’¥ó’¥¿’Àß’Äê
!
! ’ÈÆ’ÍÑ’¥ì’¥¸’¥¹’¥¿R0’¡ÁR15’¤Î’¤¦’¤ÁR15’¤¬’¥Ï’¡¼’¥É’¥¦’¥§’¥¢’¥¹’¥¿’¥Ã’¥¯’¥Ý’¥¤’¥ó’¥¿’¤Ë’»Ø’Äê’¤µ’¤ì’¤Æ’¤¤’¤ë 
! ’¥¢’¥É’¥ì’¥¹’¤Ï 0xFFFFF000’¡Á0xFFFFFFFF ’¤Î’Æâ’Â¡RAM’¤ò’»È’ÍÑ’¤¹’¤ë’¤¿’¤á’¡¢ 
! STACK_ROOT’¤Ï0x0’¤ò’Æþ’¤ì’¤Æ’¤ª’¤¯ 
!-----------------------------------------------------------------------------
    MOV.L    STACK_ROOT,    r15
!-----------------------------------------------------------------------------
! ’³Æ’¥Ý’¡¼’¥È’½é’´ü’²½
! ’½©’·î’À½’¤Î’¥Þ’¥¤’¥³’¥ó’¥­’¥Ã’¥È’¤Ç’¤Ï’É¸’½à’¤Ç’³°’ÉôRAM’¤¬’¼Â’Áõ’¤µ’¤ì’¤Æ’¤¤’¤ë’¡¥mode2’¤Ë’¥»’¥Ã’¥È’¤¹’¤ë
!-----------------------------------------------------------------------------
    MOV.L       BCR1,     r1         ! BCR1   -> r1
    MOV.W       D_BCR1,   r0         ! D_BCR1 -> r0
    MOV.W       r0,       @r1
    MOV.L       BCR2,     r1         ! BCR2   -> r1
    MOV.W       D_BCR2,   r0         ! D_BCR2 -> r0
    MOV.W       r0,       @r1
    MOV.L       WCR1,     r1         ! WCR1   -> r1
    MOV.W       D_WCR1,   r0         ! D_WCR1 -> r0
    MOV.W       r0,       @r1
    MOV.L       PACRH,    r1         ! PACRH   -> r1
    MOV.W       D_PACRH,  r0         ! D_PACRH -> r0
    MOV.W       r0,       @r1
    MOV.L       PACRL1,   r1         ! PACRL1   -> r1
    MOV.W       D_PACRL1, r0         ! D_PACRL1 -> r0
    MOV.W       r0,       @r1
    MOV.L       PBCR1,    r1         ! PBCR1   -> r1
    MOV.W       D_PBCR1,  r0         ! D_PBCR1 -> r0
    MOV.W       r0,       @r1
    MOV.L       PBCR2,    r1         ! PBCR2   -> r1
    MOV.W       D_PBCR2,  r0         ! D_PBCR2 -> r0
    MOV.W       r0,       @r1
    MOV.L       PCCR,     r1         ! PCCR   -> r1
    MOV.W       D_PCCR,   r0         ! D_PCCR -> r0
    MOV.W       r0,       @r1
    MOV.L       PDCRH1,   r1         ! PDCRH1   -> r1
    MOV.W       D_PDCRH1, r0         ! D_PDCRH1 -> r0
    MOV.W       r0,       @r1
    MOV.L       PDCRH2,   r1         ! PDCRH2   -> r1
    MOV.W       D_PDCRH2, r0         ! D_PDCRH2 -> r0
    MOV.W       r0,       @r1
    MOV.L       PDCRL,    r1         ! PDCRL   -> r1
    MOV.W       D_PDCRL,  r0         ! D_PDCRL -> r0
    MOV.W       r0,       @r1
    NOP

!-----------------------------------------------------------------------------
! ROM’¤Ë’³Ê’Ç¼’¤µ’¤ì’¤Æ’¤¤’¤ë’¥Ç’¡¼’¥¿(’ÊÑ’¿ô’¤Ê’¤É)’¤òRAM’ÎÎ’°è’¤Ë’¥³’¥Ô’¡¼’¤¹’¤ë
!   RAM_BGN  : ’¥Ç’¡¼’¥¿’¤ò’³Ê’Ç¼’¤¹’¤ëRAM’ÎÎ’°è’¤Î’³«’»Ï’¥¢’¥É’¥ì’¥¹
!   RAM_END : ’¥Ç’¡¼’¥¿’¤ò’³Ê’Ç¼’¤¹’¤ëRAM’ÎÎ’°è’¤Î’½ª’Î»’¥¢’¥É’¥ì’¥¹
!   ROM_BGN : ’¼Â’ºÝ’¤Ë’¥Ç’¡¼’¥¿’¤¬’½ñ’¤­’¹þ’¤Þ’¤ì’¤Æ’¤¤’¤ëROM’ÎÎ’°è’¤Î’³«’»Ï’¥¢’¥É’¥ì’¥¹
!-----------------------------------------------------------------------------
    MOV.L       RAM_BGN,  r0        ! RAM_BGN -> r0
    MOV.L       RAM_END,  r1        ! RAM_END -> r1
    MOV.L       ROM_BGN,  r2        ! ROM_BGN -> r2
    BRA         LOOP11
    NOP
LOOP1:
    MOV.B       @r2,    r3          ! ROM’ÎÎ’°è’¤«’¤é’¥Ç’¡¼’¥¿’¤ò’¼è’ÆÀ
    MOV.B       r3,     @r0         ! RAM’ÎÎ’°è’¤Ø’¥Ç’¡¼’¥¿’¤ò’¥³’¥Ô’¡¼
    ADD         #1,     r0          ! RAM’ÎÎ’°è’¤ò’»Ø’¤¹’¥¢’¥É’¥ì’¥¹’¤ò’¥¤’¥ó’¥¯’¥ê’¥á’¥ó’¥È
    ADD         #1,     r2          ! ROM’ÎÎ’°è’¤ò’»Ø’¤¹’¥¢’¥É’¥ì’¥¹’¤ò’¥¤’¥ó’¥¯’¥ê’¥á’¥ó’¥È
LOOP11:
    CMP/eq      r0,     r1          ! RAM_BGN == RAM_END ’¤Ê’¤é’¤Ð T=1
    BF          LOOP1               ! T=1 ’¤Ê’¤é’¤Ð LOOP1’¤Ø
    NOP
END_LOOP1:

!-----------------------------------------------------------------------------!
!   ’½é’´ü’²½’Ìµ’¤·’¤Î’¥°’¥í’¡¼’¥Ð’¥ë’ÊÑ’¿ô’¤ò0’¤Ç’½é’´ü’²½
!   BSS_BGN  : ’½é’´ü’²½’Ìµ’¤·’¤Î’¥°’¥í’¡¼’¥Ð’¥ë’ÊÑ’¿ô’¤¬’³Ê’Ç¼’¤µ’¤ì’¤Æ’¤¤’¤ë’³«’»Ï’¥¢’¥É’¥ì’¥¹
!   BSS_END : ’½é’´ü’²½’Ìµ’¤·’¤Î’¥°’¥í’¡¼’¥Ð’¥ë’ÊÑ’¿ô’¤¬’³Ê’Ç¼’¤µ’¤ì’¤Æ’¤¤’¤ë’½ª’Î»’¥¢’¥É’¥ì’¥¹
!-----------------------------------------------------------------------------
    MOV.L       BSS_BGN,  r0        ! BSS_BGN -> r0
    MOV.L       BSS_END,  r1        ! BSS_END -> r1
    BRA         LOOP21
    NOP
LOOP2:
    MOV         #0,     r3          ! r3=0
    MOV.B       r3,     @r0         ! ’¥°’¥í’¡¼’¥Ð’¥ë’ÊÑ’¿ô’¤Î’ÎÎ’°è’¤Ë0’¤ò’Âå’Æþ
    ADD         #1,     r0          ! ’ÎÎ’°è’¤ò’»Ø’¤¹’¥¢’¥É’¥ì’¥¹’¤ò’¥¤’¥ó’¥¯’¥ê’¥á’¥ó’¥È
LOOP21:
    CMP/eq      r0,     r1          ! BSS_BGN == BSS_END ’¤Ê’¤é’¤Ð T=1
    BF          LOOP2               ! T=1 ’¤Ê’¤é’¤Ð LOOP2’¤Ø
    NOP
END_LOOP2:

!-----------------------------------------------------------------------------
! main’´Ø’¿ô’¸Æ’¤Ó’½Ð’¤·
!-----------------------------------------------------------------------------
START_MAIN:                         ! main’¤òCALL
    MOV.L       MAIN_ADRS, r0       ! main’´Ø’¿ô’¤Î’¥¢’¥É’¥ì’¥¹ -> R0
    JSR         @r0                 ! main’¤Ø’¤Î’¥¸’¥ã’¥ó’¥×’¥µ’¥Ö’¥ë’¡¼’¥Á’¥ó
    OR          r0,     r0          ! JSR’Ì¿’Îá’¤Ï’ÃÙ’±ä’Ê¬’´ô’¤Î’¤¿’¤á
                                    ! (’ÃÙ’±ä’Ê¬’´ô’¤È’¤ÏJSR’Ä¾’¸å’¤Î’Ì¿’Îá’¤ò’Àè’¤Ë’¼Â’¹Ô)

! ’Ëü’¤¬’°ìmain’¤¬’½ª’Î»’¤·’¤Æ’Ìá’¤Ã’¤Æ’¤­’¤Æ’¤â’Ìµ’¸Â’¥ë’¡¼’¥×’¤Ë’¤·’¤Æ’Ää’»ß’¤µ’¤»’¤ë 
FOREVER:
    BRA         FOREVER
    OR          r0,     r0

	
.align  4                               ! 4Byte = 32Bit’¸Ç’Äê
!----’¼Â’¹Ô’»þ’¤Ë’»²’¾È’¤µ’¤ì’¤ë’½é’´ü’ÃÍ’Í­’¤ê’¥Ç’¡¼’¥¿’¤Î’ÎÎ’°è’¡ÊRAM’ÎÎ’°è’¡Ë----
RAM_BGN:            .long   _dataRAM_begin    ! ’³«’»Ï’¥¢’¥É’¥ì’¥¹ 
RAM_END:            .long   _dataRAM_end      ! ’½ª’Î»’¥¢’¥É’¥ì’¥¹ 
!----’¥ê’¥ó’¥¯’»þ’¤Ë’»²’¾È’¤µ’¤ì’¤ë’½é’´ü’ÃÍ’Í­’¤ê’¥Ç’¡¼’¥¿’¤Î’½é’´ü’ÃÍ’ÎÎ’°è’¡ÊROM’ÎÎ’°è’¡Ë----
ROM_BGN:            .long   _dataROM_begin    ! ’³«’»Ï’¥¢’¥É’¥ì’¥¹ 
!----’¼Â’¹Ô’»þ’¤Ë’»²’¾È’¤µ’¤ì’¤ë’½é’´ü’ÃÍ’¤Ê’¤·’¥Ç’¡¼’¥¿’¤Î’ÎÎ’°è’¡ÊRAM’ÎÎ’°è’¡Ë----
BSS_BGN:            .long   _bss_begin        ! ’³«’»Ï’¥¢’¥É’¥ì’¥¹ 
BSS_END:            .long   _bss_end          ! ’½ª’Î»’¥¢’¥É’¥ì’¥¹ 

STACK_ROOT:         .long   0x0               !’¥¹’¥¿’¥Ã’¥¯’¥Ý’¥¤’¥ó’¥¿’¤Î’½é’´ü’ÃÍ
MAIN_ADRS:          .long   _main             !main’´Ø’¿ô

    .align  4
BCR1:    .long 0xffff8620
BCR2:    .long 0xffff8622
WCR1:    .long 0xffff8624
PACRH:   .long 0xffff8388
PACRL1:  .long 0xffff838c
PBCR1:   .long 0xffff8398
PBCR2:   .long 0xffff839a
PCCR:    .long 0xffff839c
PDCRH1:  .long 0xffff83a8
PDCRH2:  .long 0xffff83aa
PDCRL:   .long 0xffff83ac

!----’³°’ÉÕ’¤±’¥«’¥¦’¥ó’¥¿IC’¤Î’Àß’Äê(CS0)’¤Ï’¤³’¤³’¤Ç’¤¹’¤ë ----
D_BCR1:    .short 0x203f ! CS2/CS3 are 16bit-bus,CS0,CS1 is 32 bit
                         ! 0010 0000 0011 1111
D_BCR2:    .short 0x5610 ! CS1/CS2/CS3 wait 1 idle,CS0 wait 2 idle
                         ! 0101 0110 0001 0000
D_WCR1:    .short 0x0002 ! CS0 is 2 wait, CS1-3 are 0 wait
                         ! 0000 0000 0000 0010
D_PACRH:   .short 0x5020 ! WRHH WRHL DRAK0 are enable
                         ! 0101 0000 0010 0000
D_PACRL1:  .short 0x5550 ! CK -RD -WRH -WRL -CS[1..0] are enable
                         ! 0101 0101 0101 0000
D_PBCR1:   .short 0x000a ! A21/A20 are enable
D_PBCR2:   .short 0xa005 ! A19/A18/A17/16 are enable
D_PCCR:    .short 0xffff ! A15-0 are enable
D_PDCRH1:  .short 0x5555 ! D31-24 are enable
D_PDCRH2:  .short 0x5555 ! D23-16 are enable
D_PDCRL:   .short 0xffff ! D15-0 are enable

! void setIntMask(int mask)   r4:mask r2:work r1:srreg
    .align  4
    .global	_setIntMask
_setIntMask:
    stc      sr,r1          ! srreg = __sr__
    mov.l    MASKVALUER,r2
    and      r2,r1          ! srreg &= 0xffffff0f
    shll2    r4             ! mask <<= 2
    shll2    r4             ! mask <<= 2
    mov.l    MASKVALUE,r2
    and      r2,r4          ! mask &= 0x00f0
    or       r4,r1          ! srreg |= mask
    ldc      r1,sr 
    rts	
    nop

! ’¤³’¤Î’´Ø’¿ô’¤ÏIntMask’¤ò’ÊÖ’¤·’¤Þ’¤¹’¡£ 
! int getIntMask(void)
    .align  4
    .global	_getIntMask
_getIntMask:
    stc      sr,r0
    mov.l    MASKVALUE,r2
    and      r2,r0
    shlr2    r0
    shlr2    r0
    rts	
    nop

    .align  4
MASKVALUE:    .long  0x000000f0
MASKVALUER:   .long  0xffffff0f

! ’¼¡’¤Î’´Ø’¿ô’¤Ï’¥ê’¥ó’¥«’¤¬’¥Ç’¥Õ’¥©’¥ë’¥È’´Ø’¿ô’·²’¤ò’¤Ä’¤±’¤ë’¤Î’¤ò’ËÉ’¤®’¤Þ’¤¹ 
    .align  4
    .global ___main
___main:
    rts	
    nop



.end
	